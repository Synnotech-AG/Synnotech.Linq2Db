# Synnotech.Linq2Db.MsSqlServer

*Extensions for Linq2Db that target Microsoft SQL Server*

[![License](https://img.shields.io/badge/License-MIT-green.svg?style=for-the-badge)](https://github.com/Synnotech-AG/Synnotech.Linq2Db/blob/main/LICENSE)
[![NuGet](https://img.shields.io/badge/NuGet-7.0.0-blue.svg?style=for-the-badge)](https://www.nuget.org/packages/Synnotech.Linq2Db.MsSqlServer/)

# How to install

Synnotech.Linq2Db.MsSqlServer is compiled against [.NET Standard 2.0 and 2.1](https://docs.microsoft.com/en-us/dotnet/standard/net-standard) and .NET Framework 4.6.2, thus supporting all major plattforms like .NET 6, .NET Core, .NET Framework 4.6.2 or newer, Mono, Xamarin, UWP, or Unity.

Synnotech.Linq2Db.MsSqlServer is available as a [NuGet package](https://www.nuget.org/packages/Synnotech.Linq2Db.MsSqlServer/) and can be installed via:

- **Package Reference in csproj**: `<PackageReference Include="Synnotech.Linq2Db.MsSqlServer" Version="7.0.0" />`
- **dotnet CLI**: `dotnet add package Synnotech.Linq2Db.MsSqlServer`
- **Visual Studio Package Manager Console**: `Install-Package Synnotech.Linq2Db.MsSqlServer`

# What does Synnotech.Linq2Db.MsSqlServer offer you?

Synnotech.Linq2Db implements the session abstractions of [Synnotech.DatabaseAbstractions](https://github.com/Synnotech-AG/Synnotech.DatabaseAbstractions) for Linq2Db 3.3.0 or newer. This allows you to simplify the code in your data access layer. Furthermore, Synnotech.Linq2Db.MsSqlServer allows you to configure your DI container with one call when you want to use the Synnotech default settings.

Please see the [general docs](https://github.com/Synnotech-AG/Synnotech.Linq2Db/blob/main/readme.md) on how to write custom session.

# Default configuration

Synnotech.Linq2Db.MsSqlServer provides an extension method for `IServiceCollection` to easily get you started in e.g. ASP.NET Core Apps. Simply call `AddLinq2DbForSqlServer`:

```csharp
public void ConfigureService(IServiceCollection services)
{
    // All other services like MVC are left out for brevity's sake 
    services.AddLinq2DbForSqlServer();
}
```

The method will do the following:

1. Load the `Linq2DbSettings` from the `IConfiguration` instance that is already present in the DI container and register it as a singleton.
1. Create a Linq2Db `IDataProvider` for MS SQL Server and register it as a singleton.
1. Create an instance of `LinqToDbConnectionOptions` which configures the data provider, connection string, and trace level, and register it as a singleton.
1. Register the `DataConnection` with a transient lifetime (by default). The `LinqToDbConnectionOptions` singleton will be passed into the data connection.
1. Register a `Func<DataConnection>` as a singleton, which allows to resolve a data connection dynamically in code (this is also a required dependency for the `ISessionFactory<T>` implementation).

You can configure LinqToDb via your appsettings.json file

```jsonc
{
    // other configuration sections are left out for brevity's sake
    "database": {
        "connectionString": "Server=(localdb)\\MsSqlLocalDB;Database=MyDatabase;Integrated Security=True",
        "sqlServerVersion": "v2017", // Corresponds to LinqToDB's SqlServerVersion enumeration, default value is v2017 if left out
        "traceLevel": "Off" // Corresponds to System.Diagnostic.TraceLevel, used for logging SQL statements generated by LinqToDb
    }
}
```

When you set `traceLevel` to a value other than `TraceLevel.Off`, your services also need to have an `ILogger<T>` (from Microsoft.Extensions.Logging) registered. It will be used for data connection tracing. We recommend `TraceLevel.Info` to log all SQL statements in situations where you need to inspect the generated SQL statements, otherwise leave it off because it has a severe impact on performance and log file size.

Please note: the configuration is only loaded once during startup. If you change the database settings, you need to restart your web app.

`AddLinq2DbForSqlServer` has several optional parameters that you can supply:

- `mappingSchema`: an instance of Linq2DB mapping schema. You do not need to provide this instance when you use attributes on your data access model classes. However, we highly encourage you to not use attributes but use a single method were you define the mapping configuration (this makes it easier to customize or replace the data access layer).
- `sqlServerProvider`: the enum value that indicates whether you want to use `Microsoft.Data.SqlClient` or `System.Data.SqlClient` as the underlying data provider. We recommend to use the former one (unless you have issues with it, e.g. when you want to use [spatial types or SqlHierarchyId]()) as it will receive updates more frequently. `System.Data.SqlClient` is part of the .NET Base Class Library.
- `configurationSectionName`: the section name that is used to retrieve the `Linq2DbSettings` from the `IConfiguration` instance already registered with the DI container. The default value is "database".
- `dataConnectionLifetime`: the enumeration value indicating the service lifetime for `DataConnection`. The default value is `ServiceLifetime.Transient`.
- `registerFactoryDelegateForDataConnection`: the value indicating whether a `Func<DataConnection>` should be registered with the DI Container. The default value is `true`. You can set this value to false if you use a proper DI container like [LigthInject](https://github.com/seesharper/LightInject) that supports [Function Factories](https://www.lightinject.net/#function-factories), or null when you want to configure this via `ContainerSettingsContext.Settings`.

If you don't want to use `AddLinq2DbForSqlServer`, you might still want to reuse its internal functionality. Just take a look at the source code of `Linq2DbSettings`, `CreateSqlServerDataProvider`, `CreateLinq2DbConnectionOptions`, and `LogLinq2DbMessage`.
